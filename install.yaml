name: site-metrics-cakephp

project_files:
  - config.site-metrics-cakephp.yaml
  - docker-compose.cakephp-logs.yaml
  - alloy/cakephp-logs.alloy
  - alloy/otelcol.alloy

post_install_actions:
  - #ddev-description:Remove log bind if 'site-metrics' is not installed
  - |
    if ddev addon list --installed | grep -v ' site-metrics ' && grep -q '#ddev-generated' docker-compose.cakephp-logs.yaml; then
      rm docker-compose.cakephp-logs.yaml
    fi
  - #ddev-description:Restart to activate PHP module
  - ddev restart
  - #ddev-description:Add required composer packages
  - ddev composer require open-telemetry/sdk open-telemetry/opentelemetry-auto-cakephp open-telemetry/exporter-otlp --dev -n
  - ddev composer require open-telemetry/opentelemetry-auto-pdo open-telemetry/opentelemetry-auto-psr15 open-telemetry/opentelemetry-auto-psr18 --dev -n
  - ddev composer require open-telemetry/opentelemetry-auto-psr3 php-http/guzzle7-adapter --dev -n
  - ddev composer config allow-plugins.php-http/discovery true -n
  - #ddev-nodisplay
    #ddev-description:Set default environment variables
  - ddev dotenv set .ddev/.env.web --otel-php-autoload-enabled=true > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-service-name=cakephp > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-metric-exporter=none > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-logs-exporter="otlp" > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-php-psr3-mode="export" > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-traces-exporter="otlp" > /dev/null 2>&1
  - ddev dotenv set .ddev/.env.web --otel-exporter-otlp-endpoint="http://grafana-alloy:4318" > /dev/null 2>&1

ddev_version_constraint: '>= v1.24.3'
